<!--
`juicy-tile-list element` - masonry-like Custom Element for sortable tiles that packs efficiently without changing HTML structure (changes CSS only).

@element juicy-tile-list
@demo https://Juicy.github.io/juicy-tile-list/
version: 1.3.2

@TODO: (tomalec) Create setup listener, to work better with Polymer tempalte binding, editor, and inline changes
--><script src="rectangle.js"></script><script src="packer.js"></script><script src="package.js"></script><template id="juicy-tile"><div class="juicy-tile"><content></content></div></template><template id="juicy-tile-list"><style>:host{display:block}#container{position:relative;z-index:0}polyfill-next-selector{content:':host #container> .juicy-tile'}.juicy-tile{position:absolute;display:inline-block}polyfill-next-selector{content:':host #container> .containerBackground'}.containerBackground{position:absolute;z-index:-1}</style><div id="container" class="animate"></div><content></content></template><script>!function(){function e(e){var t=e.offsetWidth,i=window.getComputedStyle(e,null),r=parseFloat(i.getPropertyValue("border-left"))||0,n=parseFloat(i.getPropertyValue("border-right"))||0,s=parseFloat(i.getPropertyValue("padding-left"))||0,a=parseFloat(i.getPropertyValue("padding-right"))||0;return t-r-n-s-a}function t(e){var t=e.offsetHeight,i=window.getComputedStyle(e,null),r=parseFloat(i.getPropertyValue("border-top"))||0,n=parseFloat(i.getPropertyValue("border-bottom"))||0,s=parseFloat(i.getPropertyValue("padding-top"))||0,a=parseFloat(i.getPropertyValue("padding-bottom"))||0;return t-r-n-s-a}function i(e,t){return Array.prototype.slice.call(t).filter(function(t){return t instanceof Text&&t.data.trim()&&console.error("juicy-tile-list can only render DOM element nodes. Provided input contains a text node which cannot be rendered. Wrap it in a <div> to fix the problem. Problematic text node: ",t," (",e.getAttribute("name"),")"),!(t instanceof Text||t instanceof HTMLLinkElement||t instanceof HTMLStyleElement||t instanceof HTMLTemplateElement||"PUPPET-MORPHURL"==t.nodeName||t instanceof HTMLScriptElement||t instanceof Comment)})}function r(e){for(var t=1,i=0,r=e.length;r>i;i++)e[i].priority<t&&(t=e[i].priority);return 0>t&&(t=0),t}function n(e,t){var i=e;for(i=i.parentNode;i&&"BODY"!=i.tagName;){if(i.tagName==e.tagName){i.addEventListener("juicy-tile-list-refresh",t);break}i=i.parentNode}}function s(e,t){var i=e;for(i=i.parentNode;i&&"BODY"!=i.tagName;){if(i.tagName==e.tagName){i.removeEventListener("juicy-tile-list-refresh",t);break}i=i.parentNode}}function a(e,t){t.shadowContainer.children.length&&(t.shadowContainer.innerHTML="");for(var i,r,n,s,a=[],o="",h=0,l=document.createDocumentFragment(),u=0,c=e.length;c>u;u++)n=e[u],"JUICY-TILE-GROUP"!==n.tagName?(s=o+h,h++,i=document.importNode(d,!0),r=i.children[0],r.id=s,r.element=n,r.firstChild.setAttribute("select","[juicytile='"+s+"']"),l.appendChild(i),n.setAttribute("juicytile",s),a.push(r),a[s]=r):(o=n.getAttribute("name")||"",o+="/",h=0);return t.shadowContainer.appendChild(l),a.root=t.shadowContainer,this._isShadomDOMOutdated=void 0,a}function o(e,t,i,r,n){for(var s,a,h,l,d,u,c=e.items.length;c--;)if(s=e.items[c],a=t[s.id]){if(h=a.style,u=n||s.hidden)h.display="none";else{h.display="",l=e.rightToLeft?e.width-s.width-s.x:s.x||0,l+=i,d=e.bottomUp?e.height-s.height-s.y:s.y||0,d+=r;var p=s.oversize||0;h.left=l+"px",h.top=d+"px",h.width=s.width+"px",h.height=s.height+"px",h.backgroundColor=void 0!==s.background?s.background||"transparent":"",h.outline=s.outline||"",p?(h.padding=p+"px",h.margin="-"+p+"px"):(h.padding="",h.margin="")}s.items&&o(s,t,l,d,u)}}function h(e,t){return e&&t&&Object.getOwnPropertyNames(t).forEach(function(i){var r=Object.getOwnPropertyDescriptor(t,i);r&&(Object.defineProperty(e,i,r),"function"==typeof r.value&&(r.value.nom=i))}),e}var l=(document._currentScript||document.currentScript).ownerDocument,d=l.getElementById("juicy-tile").content,u=l.getElementById("juicy-tile-list");window.ShadowDOMPolyfill&&WebComponents.ShadowCSS.shimStyling(u.content,"juicy-tile-list");var c={width:256,height:128,priority:0},p=h(HTMLElement.prototype,Package.prototype),f=Object.create(p),g=f;g.elements=null,g.tiles=null,g.allItems=null,g.duration=.5,g.refreshOnMutation=!1,g.refreshOnResize=!1,g.refreshOnAttached=!0,g.defaultTileSetup=c,g._isShadomDOMOutdated=!0,g.createdCallback=function(){var e=this.setup||null;Object.defineProperty(this,"setup",{get:function(){return e},set:function(t){var i;t!==e&&(i=e,e=t,this._setupChanged(i,t))}}),this.attributeChangedCallback("setup",void 0,this.getAttribute("setup")),this.attributeChangedCallback("defaulttilesetup",void 0,this.getAttribute("defaulttilesetup"));var t=this;this.observer=new MutationObserver(function(e){if(t.isReady){var i=!1;e.forEach(function(e){(e.addedNodes.length||e.removedNodes.length)&&(i=!0)}),i&&(t.allItems=null,Package.call(t,t.setup),t.createItemsList(),t.refresh(!0))}}),this.refresh=this.refresh.bind(this)},g.sorter=function(e,t){return t.priority-e.priority},g.updateWrappers=a,g._defaultSetup=function(e,t,i,n){for(var s,a=0,o=e.length;o>a;a++){var h=e[a];i[h.id]||(s=h.element.hasAttribute("juicy-style")?this.parseRules(h.element.getAttribute("juicy-style")):h.defaultSetup||JSON.parse(JSON.stringify(n)),s.priority=0==t.length?.5:r(t)*(1-1/o),s.id=h.id,Object.defineProperty(s,"container",{value:i.root,writable:!0}),t.push(s),i[h.id]=s)}},g.createItemsList=function(){this.elements=i(this,this.childNodes),this.tiles=this.updateWrappers(this.elements,this),this._defaultSetup(this.tiles,this.setup.items,this.allItems,this.defaultTileSetup)},g.attachedCallback=function(){if(this.attributeChangedCallback("refreshonattached",this.refreshOnAttached),this.refreshOnAttached&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var e=this;setTimeout(function(){e._attachedCallback()})}else this._attachedCallback()},g._attachedCallback=function(){var e=this.createShadowRoot(),t=u,i=document.importNode(t.content,!0);e.appendChild(i),this.shadowContainer=e.querySelector("#container"),Package.call(this,this.setup&&void 0!==this.setup.items?this.setup:void 0),void 0!=this.gutter&&(this.setup.gutter=parseInt(this.gutter,10)),this.createItemsList(),this.attributeChangedCallback("refreshonresize",this.refreshOnResize),this.attributeChangedCallback("refreshonmutation",this.refreshOnMutation),this.attributeChangedCallback("refreshonattached",this.refreshOnAttached),this.refreshOnAttached&&this.refresh(),this.isReady=!0},g.detachedCallback=function(){this.observer.disconnect(),this.isReady=!1},g.addResizeListeners=function(){document.attachEvent?this.attachEvent("onresize",this.refresh):n(this,this.refresh),window.addEventListener("resize",this.refresh,!0)},g.removeResizeListeners=function(){document.attachEvent?this.detachEvent("onresize",this.refresh):s(this,this.refresh),window.removeEventListener("resize",this.refresh,!0)},g.deleteContainer=function(e,t){var i=Package.prototype.deleteContainer.call(this,e,t),r=this.tiles[i.id];return r.parentNode.removeChild(r),i},g.cleanupDOM=function(){for(var e=this.shadowContainer.querySelectorAll(".containerBackground"),t=0,i=e.length;i>t;t++)e[t].parentNode.removeChild(e[t])},g.packItems=function(e){e||(e=this.setup);var t=this.tiles;if(t)for(var i,r,n=e.items.length;n--;)if(i=e.items[n],r=t[i.id],void 0!==i.items&&(r?r.parentNode||this.shadowContainer.appendChild(r):(r=document.createElement("DIV"),r.className="containerBackground",t[i.id]=r,r.id=i.id,this.shadowContainer.appendChild(r)),void 0!=i.content&&(r.innerHTML=i.content)),r&&!i.items){var s=r.style.padding;r.style.padding="",i.precalculateWidth&&(r.style.width="",i.width=r.scrollWidth),i.precalculateHeight&&(i.precalculateWidth||(r.style.width="string"==typeof i.width?i.width:i.width+"px"),r.style.height="",i.height=r.scrollHeight),r.style.padding=s}return Package.prototype.packItems.call(this,e)},g.refresh=function(i){i&&(this.tiles=this.updateWrappers(this.elements,this)),"vertical"!=this.setup.direction?(this.setup.width=this.setup.width||e(this),this.setup.precalculateHeight=!0):(this.setup.height=this.setup.height||t(this),this.setup.precalculateWidth=!0);var r=this.packItems();this.renderer(r,this.tiles,0,0),this.dispatchEvent(new CustomEvent("juicy-tile-list-refresh"))},g._setupChanged=function(e){this.isReady&&null!==e&&(this.cleanupDOM(),Package.call(this,this.setup),this.createItemsList(),console.info("refresh"),this.refresh(this._isShadomDOMOutdated))},g.getBooleanAttribute=function(e,t){var i=this.getAttribute(e);return i&&"false"===i.toLowerCase()?!1:this.hasAttribute(e)||t},g.isPoolymerBinding=function(e){return/[{][{]/gi.test(e)},g.attributeChangedCallback=function(e,t,i){switch(e){case"refreshonattached":this.refreshOnAttached=this.getBooleanAttribute(e,!0);break;case"refreshonmutation":this.refreshOnMutation=this.getBooleanAttribute(e,!1),this.refreshOnMutation?this.observer.observe(this,{childList:!0}):this.observer.disconnect();break;case"refreshonresize":this.refreshOnResize=this.getBooleanAttribute(e,!1),this.refreshOnResize?this.addResizeListeners():this.removeResizeListeners();break;case"setup":if(i&&"string"==typeof i){if(this.isPoolymerBinding(i))return;try{i=JSON.parse(i)}catch(r){console.warn("Invalid JSON provided for setup\r\n",r,i)}this.setup=i}else this.setup=i;break;case"defaulttilesetup":if(i){if("string"==typeof i){if(this.isPoolymerBinding(i))return;try{this.defaultTileSetup=JSON.parse(i)}catch(r){console.warn("Invalid JSON provided for defaultTileSetup\r\n",r,i),this.defaultTileSetup=c}}}else this.defaultTileSetup=c}},g._getMinimumDimension=function(e,t,i){var r=[];if(e.length<1)throw new Error("I need at least one element");e.sort(function(e,i){return e[t]-i[t]}),r.push({start:e[0][t],end:e[0][t]+e[0][i]});for(var n=1,s=e.length;s>n;n++){var a=r[r.length-1],o=e[n][t],h=e[n][t]+e[n][i];a.end<o?r.push({start:o,end:h}):a.end<h&&(a.end=h)}for(var l=0,n=0,s=r.length;s>n;n++)l+=r[n].end-r[n].start;return l},g.getMinimumDimensions=function(e){return{width:this._getMinimumDimension(e,"offsetLeft","offsetWidth"),height:this._getMinimumDimension(e,"offsetTop","offsetHeight")}},g.renderer=function(e,t,i,r){this.shadowContainer.style.width=e.width+"px",this.shadowContainer.style.height=e.height+"px",o(e,t,i,r)},g.bind=function(e,t,i){if("setup"===e||"defaultTileSetup"===e){var r=function(t){this[e]=t}.bind(this),n=t.open(r);r(n);var s={close:function(){t.close()}};return this[e+"Observer"]=s,s}return HTMLElement.prototype.bind.call(this,e,t,i)},g.parseRules=function(e){var t={};e=e.split(";");for(var i=0;i<e.length;i++){var r=e[i];if(r=r.trim(),-1!==r.indexOf(":")){r=r.split(":");var n=r[0].trim(),s=r.slice(1).join(":").trim();"0"===s&&(s=0),("width"===n||"height"===n)&&s.indexOf("px")>-1&&(s=parseFloat(s)),t[n]=s}else""!==r&&console.warn("juicy-style for ",this," contains defective declaration: ",r)}return t},window.JuicyTileList=document.registerElement("juicy-tile-list",{prototype:f})}();</script>