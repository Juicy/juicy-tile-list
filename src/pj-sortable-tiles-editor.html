<link rel="import" href="element-selector.html">

<polymer-element name="pj-sortable-tiles-editor">
  <template>
    <style>
      .editablesContainer {
        display: flex;
      }

      .editableGroup {
        flex: 1 1 auto;
      }

      label {
        display: inline-block;
        white-space: nowrap;
      }

      .val {
        display: inline-block;
        width: 40px;
      }

      .disabled .val {
        visibility: hidden;
      }

      .disabled .editable {
        opacity: 0.5;
        pointer-events: none;
      }

      button.active {
        box-shadow: inset 0 0 10px #000000;
      }

      h4 {
        margin: 0;
      }
    </style>
    <div class="{{ {editablesContainer: true, disabled: !editedItem} | tokenList }}">
      <div class="editableGroup">
        <button class="{{ {active: selectionMode} | tokenList }}" on-click="{{toggleSelectionMode}}">✎</button>
      </div>

      <div class="editableGroup">
        <button class="editable" on-click="{{editContainer}}" disabled?="{{!editedItem.container}}">↰ Select container</button>

      </div>
      <template if="{{editedItem.setup.items}}">
        <h4 class="editableGroup">Container <code>{{editedItem.name}}</code></h4>
        <div class="editableGroup">
          <button class="editable" on-click="{{deleteContainer}}" disabled?="{{!editedItem.container}}">Delete</button>

          <label>Gap <span class="val">({{editedItem.setup.gap}})</span></label>
          <button class="editable" on-click="{{gapIncrease}}">Inc</button>
          <button class="editable" on-click="{{gapDecrease}}">Dec</button>
        </div>
      </template>
      <div class="editableGroup"><label>Width <span class="val">({{editedItem.setup.width}})</span></label>
        <button class="editable" on-click="{{widthIncrease}}">Inc</button>
        <button class="editable" on-click="{{widthDecrease}}">Dec</button>
      </div>
      <div class="editableGroup"><label>Height <span class="val">({{editedItem.setup.height}})</span></label>
        <button class="editable" on-click="{{heightIncrease}}">Inc</button>
        <button class="editable" on-click="{{heightDecrease}}">Dec</button>
        <label class="editable"><input id="heightAutoCheckbox" type="checkbox" on-click="{{heightAuto}}"> auto</label>
      </div>
      <div class="editableGroup"><label>Priority <span class="val">({{editedItem.setup.priority}})</span></label>
        <button class="editable" on-click="{{priorityIncrease}}">Inc</button>
        <button class="editable" on-click="{{priorityDecrease}}">Dec</button>
      </div>
    </div>
    <element-selector id="elementSelector"></element-selector>
  </template>
  <script>
    (function () {
      function powerIncrease(obj, property) {
        var power = 1;
        while (power <= obj[property])
          power *= 2;
        obj[property] = power;
      }

      function powerDecrease(obj, property, minimum) {
        var power = 1;
        while (power * 2 < obj[property])
          power *= 2;
        if (power < minimum) {
          power = minimum;
        }
        obj[property] = power;
      }

      Polymer('pj-sortable-tiles-editor', {
        selectionMode: false,
        sortableTilesModel: null,
        mouseOverListener: null,
        clickListener: null,
        attached: function () {
        },
        detached: function () {
          this.$.elementSelector.hide();
          this.selectionMode = false;
          this.unlisten();
        },
        listen: function () {
          this.mouseOverListener = function (ev) {
            this.highlightedElement = null;
            var elem = ev.target;
            var highlightedElement;
            while (elem.parentNode) {
              if (elem.parentNode.nodeName == 'PJ-SORTABLE-TILES') {
                highlightedElement = elem;
                break;
              }
              elem = elem.parentNode;
            }

            if (highlightedElement) {
              if (this.highlightedElement !== highlightedElement) {
                this.highlightedElement = highlightedElement;
                this.$.elementSelector.show(this.highlightedElement);
              }
            }
          }.bind(this);
          this.clickListener = function () {
            if (this.highlightedElement) {
              this.sortableTilesModel = this.highlightedElement.parentNode;
              var highlightedItem = this.sortableTilesModel.items[ this.sortableTilesModel.filteredChildren.indexOf(this.highlightedElement) ];
              if (this.editedItem !== highlightedItem) {
                this.editedItem = highlightedItem;
                this.toggleSelectionMode();
              }
            }
          }.bind(this);
          window.addEventListener('mouseover', this.mouseOverListener);
          window.addEventListener('click', this.clickListener);
        },
        unlisten: function () {
          window.removeEventListener('mouseover', this.mouseOverListener);
          window.removeEventListener('click', this.clickListener);
        },
        toggleSelectionMode: function () {
          this.selectionMode = !this.selectionMode;
          if (this.selectionMode) {
            this.listen();
          }
          else {
            this.unlisten();
          }
        },
        gapIncrease: function () {
          this.editedItem.setup.gap++;
          this.sortableTilesModel.refresh();
        },
        gapDecrease: function () {
          if (this.editedItem.setup.gap >= 1) {
            this.editedItem.setup.gap--;
          }
          this.sortableTilesModel.refresh();
        },
        widthIncrease: function () {
          powerIncrease(this.editedItem.setup, "width");
          this.sortableTilesModel.refresh();
        },
        widthDecrease: function () {
          powerDecrease(this.editedItem.setup, "width");
          this.sortableTilesModel.refresh();
        },
        heightIncrease: function () {
          if (this.editedItem.setup.height == 'auto') { //turn off auto
            this.editedItem.setup.height = 32;
            this.shadowRoot.querySelector("#heightAutoCheckbox").checked = false;
          }
          powerIncrease(this.editedItem.setup, "height");
          this.sortableTilesModel.refresh();
        },
        heightDecrease: function () {
          if (this.editedItem.setup.height == 'auto') { //turn off auto
            this.editedItem.setup.height = 32;
            this.shadowRoot.querySelector("#heightAutoCheckbox").checked = false;
          }
          powerDecrease(this.editedItem.setup, "height");
          this.sortableTilesModel.refresh();
        },
        heightAuto: function () {
          if (this.editedItem.setup.height == 'auto') { //turn off auto
            this.editedItem.setup.height = 32;
          }
          else { //turn on auto
            this.editedItem.setup.height = "auto";
          }
          this.sortableTilesModel.refresh();
        },
        priorityIncrease: function () {
          this.sortableTilesModel.reprioritizeItem(this.editedItem, true);
        },
        priorityDecrease: function () {
          this.sortableTilesModel.reprioritizeItem(this.editedItem, false);
        },
        editContainer: function () {
          this.editedItem = this.editedItem.container;
        },
        deleteContainer: function () {
          var container = this.editedItem.container;
          this.sortableTilesModel.deleteContainer(this.editedItem);
          this.editedItem = container;
        }
      });
    })();
  </script>
</polymer-element>